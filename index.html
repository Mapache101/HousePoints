<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCIS House Points</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for browser-side rendering -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts for the visual data -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, increment, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Your Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDyFV6WAZhpr4leljJOQozPzEWlNaU-heQ",
            authDomain: "scis-house-points.firebaseapp.com",
            projectId: "scis-house-points",
            storageBucket: "scis-house-points.firebasestorage.app",
            messagingSenderId: "929403398815",
            appId: "1:929403398815:web:c6634925bfac5b665650aa"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'scis-house-points';

        const HOUSES = [
            { id: 'centaurs', name: 'Centaurs', color: '#3b82f6' }, // Blue
            { id: 'pegasus', name: 'Pegasus', color: '#22c55e' },   // Green
            { id: 'titans', name: 'Titans', color: '#eab308' },    // Yellow
            { id: 'unicorns', name: 'Unicorns', color: '#ef4444' }  // Red
        ];

        const DAILY_LIMIT = 50;

        // --- React Component ---
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = Recharts;

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('public');
            const [houseTotals, setHouseTotals] = useState({});
            const [transactions, setTransactions] = useState([]);
            const [teacherDailyTotal, setTeacherDailyTotal] = useState(0);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoading(false);
                });

                // Sync Totals
                const totalsRef = collection(db, 'artifacts', appId, 'public', 'data', 'houseTotals');
                const unsubTotals = onSnapshot(query(totalsRef), (snapshot) => {
                    const totals = {};
                    snapshot.forEach(doc => { totals[doc.id] = doc.data().points || 0; });
                    setHouseTotals(totals);
                });

                // Sync History
                const transRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                const unsubTrans = onSnapshot(query(transRef), (snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    setTransactions(list.sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds).slice(0, 10));
                });

                return () => { unsubAuth(); unsubTotals(); unsubTrans(); };
            }, []);

            useEffect(() => {
                if (!user) return;
                const today = new Date().toISOString().split('T')[0];
                const limitRef = doc(db, 'artifacts', appId, 'users', user.uid, 'limits', today);
                return onSnapshot(limitRef, (docSnap) => {
                    setTeacherDailyTotal(docSnap.exists() ? docSnap.data().totalUsed || 0 : 0);
                });
            }, [user]);

            const awardPoints = async (houseId, amount, reason) => {
                const absAmount = Math.abs(amount);
                if (teacherDailyTotal + absAmount > DAILY_LIMIT) {
                    alert(`Daily limit reached. Remaining: ${DAILY_LIMIT - teacherDailyTotal}`);
                    return;
                }
                try {
                    const today = new Date().toISOString().split('T')[0];
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'houseTotals', houseId), { points: increment(amount) }, { merge: true });
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'limits', today), { totalUsed: increment(absAmount) }, { merge: true });
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        houseId, amount, reason, teacherName: "Teacher", timestamp: Timestamp.now()
                    });
                } catch (e) { alert("Error: Check Firestore Rules"); }
            };

            if (loading) return <div className="flex h-screen items-center justify-center">Loading...</div>;

            return (
                <div className="min-h-screen">
                    <nav className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">üèÜ</span>
                            <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-green-500 bg-clip-text text-transparent">SCIS Houses</h1>
                        </div>
                        <div className="flex gap-4">
                            <button onClick={() => setView('public')} className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${view === 'public' ? 'bg-blue-50 text-blue-600' : 'text-slate-500'}`}>Leaderboard</button>
                            {user && !user.isAnonymous ? (
                                <button onClick={() => setView('teacher')} className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${view === 'teacher' ? 'bg-blue-50 text-blue-600' : 'text-slate-500'}`}>Award</button>
                            ) : (
                                <button onClick={() => setView('login')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md shadow-blue-100">Teacher Login</button>
                            )}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-4 md:p-8">
                        {view === 'public' && <Dashboard houseTotals={houseTotals} transactions={transactions} />}
                        {view === 'login' && <Login onLogin={() => signInAnonymously(auth).then(() => setView('teacher'))} />}
                        {view === 'teacher' && <Teacher awardPoints={awardPoints} remaining={DAILY_LIMIT - teacherDailyTotal} />}
                    </main>
                </div>
            );
        }

        function Dashboard({ houseTotals, transactions }) {
            const data = HOUSES.map(h => ({ name: h.name, points: houseTotals[h.id] || 0, color: h.color })).sort((a,b) => b.points - a.points);
            return (
                <div className="space-y-8 animate-in">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {data.map(h => (
                            <div key={h.name} className="bg-white p-6 rounded-2xl border text-center">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">{h.name}</p>
                                <p className="text-3xl font-bold" style={{ color: h.color }}>{h.points}</p>
                            </div>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 bg-white p-6 rounded-2xl border min-h-[400px]">
                            <h2 className="text-lg font-bold mb-6">Standings</h2>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={data}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                    <XAxis dataKey="name" axisLine={false} tickLine={false} />
                                    <YAxis hide />
                                    <Tooltip cursor={{fill: 'transparent'}} contentStyle={{borderRadius:'10px', border:'none'}} />
                                    <Bar dataKey="points" radius={[10, 10, 0, 0]}>
                                        {data.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border">
                            <h2 className="text-lg font-bold mb-4">Latest Activity</h2>
                            <div className="space-y-4">
                                {transactions.map(t => {
                                    const h = HOUSES.find(x => x.id === t.houseId);
                                    return (
                                        <div key={t.id} className="text-sm border-b pb-3 last:border-0">
                                            <p className="font-semibold">{h?.name} <span className={t.amount > 0 ? 'text-green-600' : 'text-red-600'}>{t.amount > 0 ? '+' : ''}{t.amount}</span></p>
                                            <p className="text-slate-400 text-xs italic">{t.reason}</p>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Teacher({ awardPoints, remaining }) {
            const [house, setHouse] = useState('centaurs');
            const [pts, setPts] = useState(5);
            const [reason, setReason] = useState('');
            return (
                <div className="max-w-xl mx-auto bg-white p-8 rounded-3xl border shadow-xl animate-in">
                    <h2 className="text-2xl font-bold mb-2">Award Points</h2>
                    <p className="text-sm text-slate-400 mb-6">Daily budget: <span className="font-bold text-blue-600">{remaining} pts remaining</span></p>
                    <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-2">
                            {HOUSES.map(h => (
                                <button key={h.id} onClick={() => setHouse(h.id)} className={`p-3 rounded-xl border-2 text-xs font-bold transition ${house === h.id ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-slate-50 text-slate-500'}`}>{h.name}</button>
                            ))}
                        </div>
                        <input type="number" value={pts} onChange={e => setPts(parseInt(e.target.value))} className="w-full p-4 bg-slate-50 rounded-xl border-none font-bold text-lg" />
                        <input type="text" placeholder="Reason..." value={reason} onChange={e => setReason(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl border-none" />
                        <button onClick={() => awardPoints(house, pts, reason)} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-100 disabled:opacity-50" disabled={remaining < Math.abs(pts)}>Submit Points</button>
                    </div>
                </div>
            );
        }

        function Login({ onLogin }) {
            return (
                <div className="max-w-md mx-auto text-center py-20 animate-in">
                    <div className="bg-white p-10 rounded-3xl border shadow-sm">
                        <h2 className="text-2xl font-bold mb-4">Teacher Access</h2>
                        <p className="text-slate-500 mb-8">Authenticate to start awarding points for house achievements.</p>
                        <button onClick={onLogin} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Enter Portal</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
