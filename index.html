<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCIS House Points</title>
    <!-- Styling & Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root">
        <!-- Initial Loading State -->
        <div class="flex h-screen items-center justify-center text-slate-400">
            <div class="text-center">
                <div id="loader-icon" class="mb-4 inline-block h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full loading-spin"></div>
                <p id="loader-text">Initializing SCIS Portal...</p>
                <p id="debug-info" class="text-xs mt-4 opacity-50"></p>
            </div>
        </div>
    </div>

    <!-- 1. FIREBASE INITIALIZATION -->
    <script type="module">
        console.log("Starting Firebase script...");
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, increment, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDyFV6WAZhpr4leljJOQozPzEWlNaU-heQ",
            authDomain: "scis-house-points.firebaseapp.com",
            projectId: "scis-house-points",
            storageBucket: "scis-house-points.firebasestorage.app",
            messagingSenderId: "929403398815",
            appId: "1:929403398815:web:c6634925bfac5b665650aa"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // Export to global scope so the React script can see them
            window.FirebaseDB = { db, auth, collection, doc, onSnapshot, setDoc, addDoc, increment, query, Timestamp, signInAnonymously, signOut, onAuthStateChanged };
            console.log("Firebase successfully initialized");
        } catch (error) {
            console.error("Firebase Init Error:", error);
            document.getElementById('loader-text').innerText = "Connection Error: Please check your configuration.";
        }
    </script>

    <!-- 2. REACT INTERFACE (JSX) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } = Recharts;

        const HOUSES = [
            { id: 'centaurs', name: 'Centaurs', color: '#3b82f6' }, // Blue
            { id: 'pegasus', name: 'Pegasus', color: '#22c55e' },   // Green
            { id: 'titans', name: 'Titans', color: '#eab308' },    // Yellow
            { id: 'unicorns', name: 'Unicorns', color: '#ef4444' }  // Red
        ];

        const DAILY_LIMIT = 50;
        const APP_ID = 'scis-house-points';

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('public');
            const [houseTotals, setHouseTotals] = useState({});
            const [transactions, setTransactions] = useState([]);
            const [dailyUsed, setDailyUsed] = useState(0);
            const [loading, setLoading] = useState(true);
            const [errorMsg, setErrorMsg] = useState(null);

            useEffect(() => {
                console.log("React app mounted, waiting for Firebase...");
                
                // Safety timeout: if after 10 seconds it's still loading, show an error
                const timeout = setTimeout(() => {
                    if (loading) {
                        setErrorMsg("Database connection is taking longer than expected. Please ensure you have initialized your Firestore 'houseTotals' collection.");
                        setLoading(false);
                    }
                }, 10000);

                const checkFirebase = setInterval(() => {
                    if (window.FirebaseDB) {
                        console.log("Firebase found in window! Starting app logic...");
                        clearInterval(checkFirebase);
                        startApp();
                    }
                }, 100);

                function startApp() {
                    const { auth, db, onAuthStateChanged, collection, query, onSnapshot } = window.FirebaseDB;

                    // Auth check
                    onAuthStateChanged(auth, (u) => {
                        console.log("Auth state changed:", u ? "User Logged In" : "Not Logged In");
                        setUser(u);
                        setLoading(false);
                    }, (err) => {
                        console.error("Auth Listener Error:", err);
                        setLoading(false);
                    });

                    // Sync Totals
                    const totalsRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'houseTotals');
                    onSnapshot(query(totalsRef), (snapshot) => {
                        const totals = {};
                        if (snapshot.empty) {
                            console.warn("HouseTotals collection is empty. Make sure you added the house documents!");
                        }
                        snapshot.forEach(doc => { totals[doc.id] = doc.data().points || 0; });
                        setHouseTotals(totals);
                    }, (err) => {
                        console.error("Firestore Totals Error:", err);
                        setErrorMsg("Firestore Permission Error. Ensure your Security Rules match the setup guide.");
                    });

                    // Sync History
                    const transRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions');
                    onSnapshot(query(transRef), (snapshot) => {
                        const list = [];
                        snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                        setTransactions(list.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)).slice(0, 10));
                    });
                }

                return () => clearTimeout(timeout);
            }, []);

            useEffect(() => {
                if (!user || !window.FirebaseDB) return;
                const { db, doc, onSnapshot } = window.FirebaseDB;
                const today = new Date().toISOString().split('T')[0];
                const limitRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'limits', today);
                
                return onSnapshot(limitRef, (docSnap) => {
                    setDailyUsed(docSnap.exists() ? docSnap.data().totalUsed || 0 : 0);
                });
            }, [user]);

            const awardPoints = async (houseId, amount, reason) => {
                if (dailyUsed + Math.abs(amount) > DAILY_LIMIT) {
                    alert("Daily limit reached.");
                    return;
                }
                const { db, doc, collection, setDoc, addDoc, increment, Timestamp } = window.FirebaseDB;
                const today = new Date().toISOString().split('T')[0];

                try {
                    await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'houseTotals', houseId), { points: increment(amount) }, { merge: true });
                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'limits', today), { totalUsed: increment(Math.abs(amount)) }, { merge: true });
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), {
                        houseId, amount, reason, timestamp: Timestamp.now(), teacherId: user.uid
                    });
                } catch (e) { alert("Error updating points. Check Firestore rules."); }
            };

            if (loading) return (
                <div className="flex h-screen items-center justify-center">
                    <div className="text-center">
                        <div className="h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full loading-spin mx-auto mb-4"></div>
                        <p className="text-slate-500">Connecting to Database...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    <nav className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">üèÜ</span>
                            <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-green-500 bg-clip-text text-transparent">SCIS Houses</h1>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('public')} className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${view === 'public' ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-50'}`}>Board</button>
                            {user && !user.isAnonymous ? (
                                <button onClick={() => setView('teacher')} className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${view === 'teacher' ? 'bg-blue-50 text-blue-600' : 'text-slate-500'}`}>Award</button>
                            ) : (
                                <button onClick={() => setView('login')} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold">Teacher</button>
                            )}
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto p-6">
                        {errorMsg && (
                            <div className="mb-6 p-4 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl text-sm font-medium">
                                ‚ö†Ô∏è {errorMsg}
                            </div>
                        )}
                        {view === 'public' && <Dashboard houseTotals={houseTotals} transactions={transactions} />}
                        {view === 'login' && <Login onLogin={() => window.FirebaseDB.signInAnonymously(window.FirebaseDB.auth).then(() => setView('teacher'))} />}
                        {view === 'teacher' && <Teacher awardPoints={awardPoints} remaining={DAILY_LIMIT - dailyUsed} />}
                    </main>
                </div>
            );
        }

        function Dashboard({ houseTotals, transactions }) {
            const data = HOUSES.map(h => ({ name: h.name, points: houseTotals[h.id] || 0, color: h.color })).sort((a,b) => b.points - a.points);
            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {data.map(h => (
                            <div key={h.name} className="bg-white p-6 rounded-2xl border shadow-sm text-center">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">{h.name}</p>
                                <p className="text-3xl font-bold" style={{ color: h.color }}>{h.points}</p>
                            </div>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 bg-white p-6 rounded-2xl border shadow-sm min-h-[400px]">
                            <h2 className="text-lg font-bold mb-6 text-slate-800">Standings</h2>
                            <div className="h-[300px]">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={data}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 12, fontWeight: 600}} />
                                        <YAxis hide />
                                        <Tooltip cursor={{fill: 'transparent'}} contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                        <Bar dataKey="points" radius={[10, 10, 0, 0]} barSize={50}>
                                            {data.map((entry, index) => <Cell key={index} fill={entry.color} />)}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border shadow-sm">
                            <h2 className="text-lg font-bold mb-4 text-slate-800">Activity Log</h2>
                            <div className="space-y-4">
                                {transactions.length === 0 ? <p className="text-center text-slate-400 py-10 text-sm italic">No entries yet</p> : 
                                    transactions.map(t => (
                                        <div key={t.id} className="text-sm border-b border-slate-50 pb-3 last:border-0">
                                            <div className="flex justify-between font-bold">
                                                <span style={{ color: HOUSES.find(x => x.id === t.houseId)?.color }}>{HOUSES.find(x => x.id === t.houseId)?.name}</span>
                                                <span className={t.amount > 0 ? 'text-green-600' : 'text-red-600'}>{t.amount > 0 ? '+' : ''}{t.amount}</span>
                                            </div>
                                            <p className="text-slate-500 text-xs mt-1">{t.reason}</p>
                                        </div>
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Teacher({ awardPoints, remaining }) {
            const [house, setHouse] = useState('centaurs');
            const [pts, setPts] = useState(5);
            const [reason, setReason] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAward = async () => {
                setLoading(true);
                await awardPoints(house, pts, reason);
                setReason('');
                setLoading(false);
            };

            return (
                <div className="max-w-xl mx-auto bg-white p-8 rounded-3xl border shadow-xl">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">Award Points</h2>
                        <div className="text-right">
                            <p className="text-[10px] uppercase font-bold text-slate-400">Budget</p>
                            <p className="text-lg font-bold text-blue-600">{remaining} pts</p>
                        </div>
                    </div>
                    <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-3">
                            {HOUSES.map(h => (
                                <button key={h.id} onClick={() => setHouse(h.id)} className={`p-4 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center gap-2 ${house === h.id ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-slate-50 text-slate-400 bg-slate-50'}`}>
                                    <div className="w-3 h-3 rounded-full" style={{backgroundColor: h.color}}></div>
                                    {h.name}
                                </button>
                            ))}
                        </div>
                        <div className="grid grid-cols-3 gap-4 items-center">
                            <label className="text-sm font-bold text-slate-700">Value:</label>
                            <input type="number" value={pts} onChange={e => setPts(parseInt(e.target.value) || 0)} className="col-span-2 p-3 bg-slate-50 rounded-xl border-none font-bold text-center" />
                        </div>
                        <input type="text" placeholder="Reason (e.g. Sports Day)..." value={reason} onChange={e => setReason(e.target.value)} className="w-full p-4 bg-slate-50 rounded-xl border-none" />
                        <button onClick={handleAward} disabled={loading || remaining < Math.abs(pts) || !reason} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-100 disabled:opacity-50">
                            {loading ? "Sending..." : `Award ${pts} Points`}
                        </button>
                    </div>
                </div>
            );
        }

        function Login({ onLogin }) {
            return (
                <div className="max-w-md mx-auto text-center py-20">
                    <div className="bg-white p-12 rounded-3xl border shadow-sm">
                        <div className="text-4xl mb-6">üîí</div>
                        <h2 className="text-2xl font-bold mb-4">Teacher Access</h2>
                        <p className="text-slate-500 mb-8 leading-relaxed">Please enter the portal to award points. All points are logged for tracking.</p>
                        <button onClick={onLogin} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition">Enter Portal</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
